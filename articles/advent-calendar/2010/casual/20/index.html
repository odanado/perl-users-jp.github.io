<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="yaotti <yaotti@gmail.com>">
        <title>proveをうまく使ってテスト実行を効率化しよう - Articles Advent Calendar 2010 Casual</title>
        <link rel="icon" href="/img/favicon.ico">
        <link rel="canonical" href="https://perl-users.jp/articles/advent-calendar/2010/casual/20">
        <link href="TODO" rel="stylesheet">
    </head>
    <body>
        <h1>proveをうまく使ってテスト実行を効率化しよう</h1>
        tag
            <a href='/tag/perl'>perl</a>
            <a href='/tag/test'>test</a>
            <a href='/tag/prove'>prove</a>

        <p>こん(にちは|ばんは)．最近は卒論でC/アセンブラ，アルバイトでPerl/Objective-Cと高低レイヤーを行ったり来たりな<a href="http://d.hatena.ne.jp/yaotti/">yaotti</a>です．<br />
このエントリでは，テストを実行する時に便利なproveコマンド(App::Prove)の便利な機能+αについて紹介します．</p>

<div class="section">
    <h4>基本的な使い方</h4>
    
    <pre class="code prettyprint lang-sh">prove t/foo.t</pre>
<p>のようにして使います．perlと同じように-lや-Idir，-v, -MModule::Nameなども使えます．</p>

    <pre class="code prettyprint lang-sh">prove -l -Ilib -v t/foo.t</pre>
<p>他にも，-Pオプションでプラグインを利用することもできます．<br />
例えばmotemenさんの書いた<a href="https://github.com/motemen/App-Prove-Plugin-ProgressBar-Each">App::Prove::Plugin::ProgressBar::Each</a>は大量のテストを実行するときに便利です．</p>

    <pre class="code prettyprint lang-sh">cpanm https://github.com/motemen/App-Prove-Plugin-ProgressBar-Each/tarball/master
prove -PProgressBar::Each t/*</pre>
<p>またproveの機能ではないですが，Test::Classを使っていて特定のテストのみを実行したいときは</p>

    <pre class="code prettyprint lang-sh">TEST_METHOD=_foo prove t/foo.t</pre>
<p>とすると_fooというテストのみ実行されます．</p><p></p>

</div>
<div class="section">
    <h4>stateオプション</h4>
    <p>テストをperlで実行する(perl t/foo.t)のとproveで実行する一番の違い(だと個人的に思っている)のがこのstateオプションです．</p>

    <pre class="code prettyprint lang-sh">prove --state=save t/**/*.t</pre>
<p>とするとテストの実行結果の色々(詳細は後述)を.proveに保存してくれます．そして</p>

    <pre class="code prettyprint lang-sh">prove --state=failed # ファイル名の指定はいらない!</pre>
<p>を実行すると，前回失敗したテストのみ<a href="#fn1" title="ファイル単位">*1</a>実行されます．<br />
stateオプションは複数指定できるので，--state~failed,saveを指定すれば</p>

    <pre class="code prettyprint">edit ...
prove --state=failed,save
edit ...
prove --state=failed,save
...</pre>
<p>のように編集→テストを繰り返せます．</p><p>なお，以上のオプションは毎回指定しなくても~/.provercに書いておけば毎回読んでくれます．</p>

    <pre class="code prettyprint">-v --state=failed,save -l -It/lib</pre>

</div>
<div class="section">
    <h4>.proveについて</h4>
    <p>これだけだとpodの翻訳でしかないのでちょっと追加を．<br />
prove --state=saveのときのテスト結果は.proveに保存されます．これは以下のようにYAML形式で保存されています．</p>

    <pre class="code prettyprint lang-sh">$ less .prove
---
generation: 4
last_run_time: 1292740101.18576
tests:
  t/foo.t:
    elapsed: 3.55887389183044
    gen: 5
    last_pass_time: 1292740829.4212
    last_result: 0
    last_run_time: 1292740829.4212
    last_todo: 0
    seq: 5
    total_passes: 1
  t/bar.t:
    elapsed: 5.02774810791016
    gen: 4
    last_fail_time: 1292740101.18414
    last_result: 3
    last_run_time: 1292740101.18414
    last_todo: 0
    mtime: 1292315958
    seq: 4
    total_failures: 4
version: 1
...</pre>
<p>これを利用すると，「前回失敗したテスト」「TODOのあるテスト」などの情報を得ることができます．以下でその一例を紹介します．</p><p></p>

</div>
<div class="section">
    <h4>.prove利用の例</h4>
    
    <pre class="code prettyprint lang-perl">#!/usr/bin/env perl
use strict;
use warnings;
use Cwd;
use Term::ANSIColor;
use YAML::Any;

my $prove_file = Cwd::getcwd() . &#34;/.prove&#34;;
if (-f $prove_file) {
    my $test_results = YAML::Any::LoadFile($prove_file)-&gt;{tests};
    my $failed_tests = [];
    for my $file (keys %$test_results) {
        push @$failed_tests, $file if $test_results-&gt;{$file}-&gt;{last_result} &gt; 0;
    }
    if (@$failed_tests) {
        print colored &#39;NG: &#39;, &#39;red&#39;;
        print join &#34;, &#34;, @$failed_tests;
    }else {
        print colored &#39;OK&#39;, &#39;green&#39;;
    }
}
</pre>
<p>このコードを適当な場所に保存し，~/.zshrcへ</p>

    <pre class="code prettyprint lang-sh">function precmd() {
    PROMPT+=&#34;$(perl ~/path/to/the/script.pl)&#34;
}</pre>
<p>を追記します(precmdが定義済みなら適当に追加してください)．すると，<br />
<img src="https://img.skitch.com/20101219-qnay1sygc51fb9mh1aa7jd3f7e.jpg" alt="terminal" /><br />
のように落ちたテストを表示させることができます．全部通っていると緑でOKと出ます．ちょっと嬉しいですね!<br />
.proveに保存される情報についての詳細はperldoc App::Prove::State::Result::Testを見てください．</p><p></p>

</div>
<div class="section">
    <h4>まとめ</h4>
    <p>proveには~/.provercや--stateのような便利な機能があるので，普段使ってる人も一度じっくりperldoc App::Prove::*を読んでみることをオススメします．<br />
また，自分でApp::Prove::Plugin::*を書いてみるのも楽しいかもしれません．<br />
proveを便利に使って，頑張ってテストを書きましょう!<a href="#fn2" title="自戒も込めて…">*2</a></p><br />
<p>明日はkamipoさんです!お楽しみに:)</p>

</div>
<div class="footnotes">
  <div class="footnote" id="fn1">*1: ファイル単位</div>
  <div class="footnote" id="fn2">*2: 自戒も込めて…</div>
</div>

        <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?lang=css&amp;skin=sunburst"></script>
    </body>
</html>
